# -*- mode: ruby -*-
# vi: set ft=ruby :

# Control-plane IP
kuma_cp_ip= "192.168.33.10"

boxes = [
  {
    name: "kuma-cp",
    ip: "#{kuma_cp_ip}",
    box: "ubuntu/xenial64",
    kuma: "./kuma-cp.sh"
  },
  {
    name: "frontend",
    ip: "192.168.33.20",
    box: "ubuntu/xenial64",
    file: "app",
    script: "./frontend.sh",
    kuma: "./kuma-dp.sh",
    local_port: "8080"
  },
  {
    name: "backend",
    ip: "192.168.33.30",
    box: "ubuntu/xenial64",
    file: "api",
    script: "./backend.sh",
    kuma: "./kuma-dp.sh",
    local_port: "3001"
  },
  {
    name: "elastic",
    ip: "192.168.33.40",
    box: "elastic/ubuntu-16.04-x86_64",
    script: "./elastic.sh",
    kuma: "./kuma-dp.sh",
    local_port: "9200"
  },
  {
    name: "redis",
    ip: "192.168.33.50",
    box: "ubuntu/xenial64",
    script: "./redis.sh",
    kuma: "./kuma-dp.sh",
    local_port: "6379"
  }
]

Vagrant.configure("2") do |config|

  config.vm.synced_folder "./.sync/", "/home/vagrant/kuma"

  boxes.each do |box|
    
    config.vm.define box[:name] do |srv|
      srv.vm.box = box[:box]
      srv.vm.hostname = box[:name]
      srv.vm.network :private_network, ip: box[:ip]

      if box[:file]
        srv.vm.provision "file", source: "../#{box[:file]}", destination: "$HOME/#{box[:file]}"
      end

      if box[:script]
        srv.vm.provision :shell, path: box[:script]
      end

      srv.vm.provision :shell, path: box[:kuma], :args => [
        kuma_cp_ip,
        "#{box[:name]}", 
        "#{box[:ip]}",
        "#{box[:local_port]}"
      ]
    end

  end

  # config.vm.define "kumacp-vm" do |vm1|
  #   vm1.vm.box = "ubuntu/xenial64"
  #   vm1.vm.hostname = "kumacp-vm"
  #   vm1.vm.network "private_network", ip: "192.168.33.10"
  #   vm1.vm.provision :shell, path: "./kuma.sh"
  #   # vm1.vm.provision :shell, path: "./kuma-dp.sh"
  # end

  # config.vm.define "frontend-vm" do |vm2|
  #   vm2.vm.box = "ubuntu/xenial64"
  #   vm2.vm.hostname = "frontend-vm"
  #   vm2.vm.network "private_network", ip: "192.168.33.20"
  #   vm2.vm.provision "file", source: "../app", destination: "$HOME/app"
  #   vm2.vm.provision :shell, path: "./frontend.sh"
  # end

  # config.vm.define "backend-vm" do |vm3|
  #   vm3.vm.box = "ubuntu/xenial64"
  #   vm3.vm.hostname = "backend-vm"
  #   vm3.vm.network "private_network", ip: "192.168.33.30"
  #   vm3.vm.provision "file", source: "../api", destination: "$HOME/api"
  #   vm3.vm.provision :shell, path: "./backend.sh"
  #   vm3.vm.provision :shell, path: "./kuma-dp.sh"
  # end

  # config.vm.define "elastic-vm" do |vm4|
  #   vm4.vm.box = "elastic/ubuntu-16.04-x86_64"
  #   vm4.vm.hostname = "elastic-vm"
  #   vm4.vm.network "private_network", ip: "192.168.33.40"
  # end

  # config.vm.define "redis-vm" do |vm5|
  #   vm5.vm.box = "ubuntu/xenial64"
  #   vm5.vm.hostname = "redis-vm"
  #   vm5.vm.network "private_network", ip: "192.168.33.50"
  #   # vm5.vm.provision :shell, path: "./redis.sh"
  # end

  # Use nfs instead of the default folder sync as otherwise VirtualBox will crash periodically
  # config.vm.synced_folder "./sync/", "/home/vagrant/kuma", type: "nfs"
end
